---
title: 'Project'
author: "Yixin Lian yl4089"
date: "2018/**/**"
output:
  pdf_document: 
    latex_engine: xelatex
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

```

My goal is to focus on the time variable in our dataset. Our dataset includes an even sample of the customer reviews for electronic products sold on Amazon and BestBuy websites. 
```{r}
library(tidyverse)
library(lubridate)
library(plotly)
electron_data <- 
  read.csv(file="/Users/easonlian/Desktop/programming/eda/Project/DatafinitiElectronicsProductData.csv", 
                            header=TRUE, sep=",")

```


First we take a look at the NA value of our dataset. It shows there are only four variabls have na values. The dataset is relatively complete. 

```{r}
colSums(is.na(electron_data))
```

Then we select the key variables we would like to investigate. 

```{r}
yx_select <- select(electron_data, name, brand, reviews.date, reviews.rating)
yx_select <- yx_select[rowSums(is.na(yx_select)) == 0, ] #remove na rows
yx_select$reviews.date <- as.Date(yx_select$reviews.date)
library(ggplot2)

library(tidyverse)
head(yx_select)
#yx_select$name <- abbreviate(yx_select$name, minlength = 2)
```



```{r}
library(shiny)
library(DT)
library(dplyr)
#runExample("01_hello")
product_name <- unique(yx_select$name)
brand_name <- unique(electron_data$brand)

average_rating_select <- yx_select %>% group_by(name, month = floor_date(reviews.date, unit = "month")) %>% summarise(average.rating = mean(reviews.rating, na.rm=TRUE))

average_rating_select2 <- yx_select %>% group_by(brand, month = floor_date(reviews.date, unit = "month")) %>% summarise(average.rating = mean(reviews.rating, na.rm=TRUE))

```


```{r}
#sentiment score analysis for brand
library(reshape2)
library(sentimentr)
library(plotly)
sen_text <- get_sentences(as.character(electron_data$reviews.text))
sen_text <- sentiment_by(sen_text)

electron_data_with_sentiment <- electron_data
electron_data_with_sentiment['sentiment.score'] <- sen_text$ave_sentiment

summarise_table_0 <- electron_data_with_sentiment %>% 
  select(brand, reviews.doRecommend, reviews.rating, sentiment.score)%>% 
  na.omit() %>%
  group_by(brand) %>% 
  summarise(n = n(), average.rating = sum(reviews.rating)/n(), average.sentiment = sum(sentiment.score)/n(),    prop.recommend = sum(reviews.doRecommend)/n())

sentiment_plot_brand <- plot_ly(summarise_table_0, x = ~average.rating, y = ~average.sentiment, z = ~prop.recommend, text=~paste('Brand:', brand)) %>%
  add_markers() %>%
  layout(scene = list(xaxis = list(title = 'Rating'),
                     yaxis = list(title = 'Sentiment'),
                     zaxis = list(title = 'Do Recommend')))

#sentiment score analysis for product
summarise_table_0 <- electron_data_with_sentiment %>% 
  select(name, reviews.doRecommend, reviews.rating, sentiment.score)%>% 
  na.omit() %>%
  group_by(name) %>% 
  summarise(n = n(), average.rating = sum(reviews.rating)/n(), average.sentiment = sum(sentiment.score)/n(),    prop.recommend = sum(reviews.doRecommend)/n())

sentiment_plot_product <- plot_ly(summarise_table_0, x = ~average.rating, y = ~average.sentiment, z = ~prop.recommend, text=~paste('name:', name)) %>%
  add_markers() %>%
  layout(scene = list(xaxis = list(title = 'Rating'),
                     yaxis = list(title = 'Sentiment'),
                     zaxis = list(title = 'Do Recommend')))
```

```{r}
#two y axis plot product
my_text = get_sentences(as.character(electron_data$reviews.text))
sen_text = sentiment_by(my_text)

electron_data$reviews.date <- as.Date(electron_data$reviews.date)


sentiment_df = data.frame(electron_data$name, electron_data$reviews.date,sen_text$ave_sentiment, electron_data$reviews.rating)

colnames(sentiment_df)[1]<-"name"
colnames(sentiment_df)[2]<-"review_date"
colnames(sentiment_df)[3]<-"text_scores"
colnames(sentiment_df)[4]<-"rating"

sentiment_df <- sentiment_df[rowSums(is.na(sentiment_df)) == 0, ] #remove na rows

#two y axis plot brand
sentiment_df_brand = data.frame(electron_data$brand, electron_data$reviews.date,sen_text$ave_sentiment, electron_data$reviews.rating)

colnames(sentiment_df_brand)[1]<-"brand"
colnames(sentiment_df_brand)[2]<-"review_date"
colnames(sentiment_df_brand)[3]<-"text_scores"
colnames(sentiment_df_brand)[4]<-"rating"

sentiment_df_brand <- sentiment_df_brand[rowSums(is.na(sentiment_df_brand)) == 0, ] #remove na rows
```


```{r}
# Define UI for application that draws a histogram
ui <- shinyUI(fluidPage(

  # Application title
  titlePanel("Amazon Electronic Product Data Analysis"),
  
  navbarPage(
  "Menu", 
  tabPanel("Overview"),
  tabPanel("Product",
  sidebarLayout(
    sidebarPanel(
      width = 3,
      #textInput("title", "Plot title:", value = "x v y"),
      fluidRow(selectInput("select_product", "Select a Product:", choices = product_name, selected = "Microsoft Surface Pro 4 Type Cover with Fingerprint ID"),
               div(style = "height:0px;"))
      # fluidRow(radioButtons("plot_type", "Plot Type", choices = c("Time Series", "User Review Highlight"), selected = "Time Series"),
      #          div(style = "height:50px;"))
    ),
    
    # Show a plot of the generated distribution
    mainPanel(
      tabsetPanel(
        id = "inTabset",
        tabPanel(title = "General", value = "panel1", 
          fluidRow(h3("Genenral Overview for Selected Product"),
            h4("Popularity Over Time"),
            plotlyOutput(outputId = "product_plot")),
      
          fluidRow(
            class = "myRow2",
            div(style = "margin-top:2em"),
            column(width = 6, h4("User DoRecommend"), plotOutput(outputId = "pie")), 
            column(width = 6, h4("Rating Distribution"), plotOutput(outputId = "bar"))
          )
        ),
        tabPanel(title = "User Review Text Highlight", value = "panel2", plotOutput(outputId = "product_review_analysis"))
      )
    )
  )),
  tabPanel("Brand",
    sidebarLayout(
      sidebarPanel(
        width = 3,
        fluidRow(selectInput("select_brand", "Select a Brand:", choices = brand_name, selected = "Microsoft"),
                 div(style = "height:0px;"))
      ),
      
      mainPanel(
      tabsetPanel(
        id = "inTabset2",
        tabPanel(title = "General", value = "brand_panel1", 
          fluidRow(h3("Genenral Overview for Selected Brand"),
            h4("Popularity Over Time"),
            plotlyOutput(outputId = "brand_plot")),
      
          fluidRow(
            div(style = "margin-top:2em"),
            column(width = 6, h4("User DoRecommend"), plotOutput(outputId = "pie2")), 
            column(width = 6, h4("Rating Distribution"), plotOutput(outputId = "bar2"))
          )
        ),
        tabPanel(title = "User Review Text Highlight", value = "brand_panel2", plotOutput(outputId = "brand_review_analysis"))
      )
      )
    )  
  ),
  tabPanel("Comparison",
    fluidRow(column(width = 12, 
      h3("Comparison by Product"),
      plotlyOutput(outputId = "product_comparison"),
      h3("Comparison by Brand"),
      plotlyOutput(outputId = "brand_comparison")
      
    ))
  ),
  tabPanel("Data",
    DT::dataTableOutput("data_table")
    #hover = hoverOpts(id ="plot_hover"),
    #uiOutput("my_tooltip"))
  ))
  
  )
)
#------------------------------------------------------------------------------#
##server script
#------------------------------------------------------------------------------#
server <- shinyServer(function(input, output) {
  

#------------------------------------------------------------------------------#
##product page 
#------------------------------------------------------------------------------#
  output$product_plot <- renderPlotly({
    
      selected = average_rating_select[average_rating_select$name == input$select_product,]
  
      p <- ggplot(selected,
             aes(x=month, y=average.rating)) +
        geom_line() + stat_smooth() + xlab("Month") + ylab("Average Rating")
      
      ggplotly(p, height = 400)
    
    
  })
  
  output$product_review_analysis <- renderPlot({
    
      product = sentiment_df[sentiment_df$name == input$select_product,]
      tidy_table <- product %>% group_by(month = floor_date(review_date, unit = "month")) %>% summarise(ave_review_text_scores = sum(text_scores)/n(), ave_rating = sum(rating)/n())
      tidy_table = data.frame(tidy_table)
      p <- ggplot(tidy_table, aes(x = month))
      p <- p + geom_line(aes(y = ave_review_text_scores, colour = "Sentimental Scores"))
      p <- p + geom_line(aes(y = ave_rating/13, colour = "Ave_rating")) 
      p <- p + scale_y_continuous(sec.axis = sec_axis(~.*13, name = "Average Rate stars"))
      p <- p + scale_colour_manual(values = c("blue", "red"))
      p <- p + labs(y = "Sentimental Scores",
                    x = "Month",
                    colour = "Parameter")
      p <- p + theme(legend.position = c(0.8, 0.9))
      p
  })
    
  output$pie <- renderPlot({
    
      product_recommend <- electron_data[electron_data$name == input$select_product, 'reviews.doRecommend']
      product_recommend[is.na(product_recommend)] <- "NA"
      product_recommend <- data.frame(product_recommend)
      par(mar=c(0,0,0,0))
      #pie(table(product_recommend, exclude = NULL), col = c("pink", "grey", "light green"))
      p <- ggplot(product_recommend, aes(x='', fill=product_recommend)) +
      geom_bar(width = 1, stat = "count") +
      coord_polar(theta = "y", start = 0) + theme(legend.position="top",axis.title=element_blank(),axis.ticks = element_blank())
      p 
    
  })
  
  output$bar <- renderPlot({
    
      
      par(mar=c(0,0,0,0))
      product_rating <- electron_data[electron_data$name == input$select_product, 'reviews.rating']
      product_rating <- product_rating[!is.na(product_rating)]
      product_rating <- data.frame(product_rating)
      p <- ggplot(product_rating, aes(x=product_rating)) +
          geom_bar(fill=unique(product_rating$product_rating))
      p 
    
  })
  
#------------------------------------------------------------------------------#
##brand page 
#------------------------------------------------------------------------------#
  output$brand_plot <- renderPlotly({
    selected = average_rating_select2[average_rating_select2$brand == input$select_brand,]
  
    p <- ggplot(selected,
           aes(x=month, y=average.rating)) +
      geom_line() + stat_smooth()
    
    ggplotly(p, height = 400)
  })
  
  output$brand_review_analysis <- renderPlot({
    
      product = sentiment_df_brand[sentiment_df_brand$brand == input$select_brand,]
      tidy_table <- product %>% group_by(month = floor_date(review_date, unit = "month")) %>% summarise(ave_review_text_scores = sum(text_scores)/n(), ave_rating = sum(rating)/n())
      tidy_table = data.frame(tidy_table)
      p <- ggplot(tidy_table, aes(x = month))
      p <- p + geom_line(aes(y = ave_review_text_scores, colour = "Sentimental Scores"))
      p <- p + geom_line(aes(y = ave_rating/13, colour = "Ave_rating"))
      p <- p + scale_y_continuous(sec.axis = sec_axis(~.*13, name = "Average Rate stars"))
      p <- p + scale_colour_manual(values = c("blue", "red"))
      p <- p + labs(y = "Sentimental Scores",
                    x = "Month",
                    colour = "Parameter")
      p <- p + theme(legend.position = c(0.8, 0.9))
      p
  })
  
  output$pie2 <- renderPlot({
    brand_recommend <- electron_data[electron_data$brand == input$select_brand, 'reviews.doRecommend']
    brand_recommend[is.na(brand_recommend)] <- "NA"
    brand_recommend <- data.frame(brand_recommend)
    par(mar=c(0,0,0,0))
    p <- ggplot(brand_recommend, aes(x='', fill=brand_recommend)) +
    geom_bar(width = 1, stat = "count") +
    coord_polar(theta = "y", start = 0) + theme(legend.position="top",axis.title=element_blank(),axis.ticks = element_blank())
    p
  })
  
  output$bar2 <- renderPlot({
    par(mar=c(0,0,0,0))
    brand_rating <- electron_data[electron_data$brand == input$select_brand, 'reviews.rating']
    brand_rating <- brand_rating[!is.na(brand_rating)]
    brand_rating <- data.frame(brand_rating)
    p <- ggplot(brand_rating, aes(x=brand_rating)) +
        geom_bar(fill=unique(brand_rating$brand_rating))
    p
  })

  
#------------------------------------------------------------------------------#
##comparison page 
#------------------------------------------------------------------------------# 
  output$product_comparison <- renderPlotly({
    
    ggplotly(sentiment_plot_product)
  })
  
  output$brand_comparison <- renderPlotly({
    
    ggplotly(sentiment_plot_brand)
  })
    
#------------------------------------------------------------------------------#
##data page 
#------------------------------------------------------------------------------# 
  options_new <- list(columnDefs = list(list(
  targets = "_all",
  render = JS(
    "function(data, type, row, meta) {",
    "return type === 'display' && data.length > 20 ?",
    "'<span title=\"' + data + '\">' + data.substr(0, 20) + '...</span>' : data;",
    "}")
  )))
  
  output$data_table = renderDT(electron_data,
                               options = options_new, server = TRUE)
  
  
})

shinyApp(ui, server)

```

Now in order to have a deep understanding of the time span of the variable "reviews.date", we draw a jitter plot (boxplot in this case cannot show the outliers clearly) of it first. The graph below displays that most of the data range from 2014 to 2018. 


```{r}
ggplot(data=yx_select, aes(x="", y=reviews.date)) + 
  geom_jitter()

```

```{r}

ggplot(data=yx_select, aes(x=name, y=reviews.date, color=name)) + 
  geom_point(size=1.5) + theme(legend.position="none", 
                     text = element_text(size=8)) + 
  coord_flip()

```


We want to explore the rating changes of different products by time. Hence it's also important for us to preknow the distribution of reviews number for thoes elctronic prodcuts. We draw a hitogram to clearly show the count number. The diagram below shows that the product "L9HUO1UIRwCTSC-B" has most reviews. It to some extent indicates that this product may be the most popular one among all 50 electronic products.

```{r}
#yx_select$name <- abbreviate(yx_select$name, minlength = 2)
#name_count <- yx_select %>% group_by(yx_select$name) %>% summarize(count=n())

ggplot(data=yx_select, aes(x=name, fill=name)) + 
  geom_bar() + theme(legend.position="none", 
                     text = element_text(size=8)) +
  coord_flip()
```

It's worth mentioning here that the length of product names is too long, thus we use "abbreviate" function to make all the names shorter. Corresponding names are displayed below.  

```{r}
library(lubridate)
unique(yx_select$name)
```

We can now begin to explore the ratings conditioned on date for different products. Because all 50 products will make the plot too complicated, we only look one product at a time. For example, we take "L9HUO1UIRwCTSC-B". We first focus on the review number. The diagram below shows that the changes of reviews number with time. There are some variations, such as, the review number decreses nearly half from 2017 to 2018. In order to show the time changes for all products for our project, I will try to use shiny next time so that audience can choose interested products to see their corresponding graphs. 

```{r}
review_count_select <- yx_select %>% 
  group_by(name, season = floor_date(reviews.date, unit = "season")) %>% 
   summarise(n = n()) %>% mutate(freq = n/sum(n))
#'MSP4TCwFI', "L9HUO1UIRwCTSC-B", "SSXOESRRwVK", "SM", "S4CF(SLT(", "EE7AWH(" 
selected = review_count_select[
  review_count_select$name == c("L9HUO1UIRwCTSC-B" ),]
ggplot(data=selected, 
       aes(x=season, y=freq, group=name, color=name)) +
  geom_line() + stat_smooth()
```

And we can also focus on the average ratings change by time. The following diagram shows that with time goes by, the average rating of the product "L9HUO1UIRwCTSC-B" increases from 3.8 to 4.1 and then decreases to 3.6. 

```{r}
average_rating_select <- yx_select %>% 
  group_by(name, season = floor_date(reviews.date, unit = "season")) %>% 
   summarise(average.rating = mean(reviews.rating, na.rm=TRUE))
#'MSP4TCwFI', "L9HUO1UIRwCTSC-B", "SSXOESRRwVK", "SM", "S4CF(SLT(", "EE7AWH(" 
selected = average_rating_select[
  average_rating_select$name == c("L9HUO1UIRwCTSC-B"),]
ggplot(data=selected, 
       aes(x=season, y=average.rating, group=name, color=name)) +
  geom_line() + stat_smooth()
```

It seems we can not only explore the relationships from the product perspective, but also from the brand perspective. There are more than 30 kinds of brands. That's take a look for them. 

```{r}
yx_select_brand <- select(electron_data, brand, reviews.date, reviews.rating)
yx_select_brand <- yx_select_brand[rowSums(is.na(yx_select_brand)) == 0, ] #remove na rows
yx_select_brand$reviews.date <- as.Date(yx_select_brand$reviews.date)
#brand_count <- yx_select_brand %>% group_by(yx_select_brand$name) %>% summarize(count=n())
ggplot(data=yx_select_brand, aes(x=brand, fill=brand)) + 
  geom_bar() + theme(legend.position="none", 
                     text = element_text(size=8)) +
  coord_flip()
```

And we choose "Logitech" brand for example, do the same to analyse the changes with time. 

```{r}
review_count_select <- yx_select_brand %>% 
  group_by(brand, season = floor_date(reviews.date, unit = "season")) %>% 
   summarise(n = n()) %>% mutate(freq = n/sum(n))
selected = review_count_select[
  review_count_select$brand == c("Logitech"),]
ggplot(data=selected, 
       aes(x=season, y=freq, group=brand, color=brand)) +
  geom_line() + stat_smooth()
```


```{r}

average_rating_select <- yx_select_brand %>% 
  group_by(brand, season = floor_date(reviews.date, unit = "season")) %>% 
   summarise(average.rating = mean(reviews.rating, na.rm=TRUE))
selected = average_rating_select[
  average_rating_select$brand == c("Logitech"),]
ggplot(data=selected, 
       aes(x=season, y=average.rating, group=brand, color=brand)) +
  geom_line() + stat_smooth()
```

In summary:

1. We have to admit all the electronic products will be old when the new version comes to the market. This will to some extent influence the popularity of one particular product. This will result in the decrease of review number on that product. So it seems if we look at the average rating by time, it will be more unbiased. 

2. It's also interesting to compare the relationship for different brands. Why is it interesting? I think it's because most likely if customers like one particular product, they also tend to like the other products under same brand. So it's meaningful for us to compare from brand perspective. 

3. It's also worth mentioning that we cannot decide which one is popular only by the review number. For example, if one product is suck, everyone on the Internet wants to write a bad review for it, the review number will be large, however, this is not a popular product. The average rating will play an important role in this case. 

In order to make the graph more interactive, we will try to use shiny next time. Thanks.





